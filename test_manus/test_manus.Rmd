---
title: Effects of forest management and harvest intensity on landscape level wind damage risk

author:
  - name: 'Mária Potterf'
    email: mpotterf@jyu.fi
    affiliation: Department of Biological and Environmental Science  
    footnote: 1
  - name: Kyle Eyvindson
    email: kyle.j.eyvindson@jyu.fi
    affiliation: Department of Biological and Environmental Science
  - name: Clemens Blattert 
    email: clemens.c.blattert@jyu.fi
    affiliation: Department of Biological and Environmental Science
  - name: Daniel Burgas 
    email: daniel.d.burgas-riera@jyu.fi
    affiliation: Department of Biological and Environmental Science
   # footnote: 2
  - name: Mikko Mönkkönen
    email: mikko.monkkonen@jyu.fi
    affiliation: Department of Biological and Environmental Science
   # footnote: 2
address:
  - code: University of Jyvaskyla
    address: Department of Biological and Environmental Science, University of Jyvaskyla, P.O. Box 35, FI-40014 Jyvaskyla, Finland
  - code: Wisdom
    address: This is wisdom address
  - code: LUKE
    address: THIS is Luke address Department, Street, City, State, Zip
footnote:
  - code: 1
    text: "Corresponding Author"
  - #code: 2
    #text: "Equal contribution"
abstract: |
  Future forest management needs to balance between sustainable timber, supporting non-woody ecosystem services and shelter biodiversity. Novel approaches as optimization of forest management to certain goals, increasing proportion of set-aside forest stands, or novel management approaches such as continuous forest cover emerge. However, novel ways of forest management shape forest stands structures over the landscape and will define the stand vulnerability to more frequent climatic disruptions, such as windthrows under hardening climate change. 
  To understand how will the traditional (rotation forestry, RF) and novel forest managements techniques (continuous cover forest, CCF) combined using optimal management alternate the risk of wind damages over the harvest intensity gradient (ranging from completely setaside to highest harvesting rates), we  combined the forest growth simulator under ranges of management regimes (RF, CCF and combined: ALL), optimized over the range of harvesting levels to calculate stand and landscape level wind damage risk for alternative paths of the forest management and harvesting levles over 100 years. 
  We found that higher harvest intensity in RF lowers wind risk, whereas the wind risk increased under CCF and ALL scenarios. More intensive harvesting using RF produced more pulp, while CCF provided higher volumes of the standing and harvested log wood, which likely explains higher values of wind risk probability. RF slightly increased the number of stands with open edge, which remained stable under CCF and ALL regimes. Intensive harvesting may change species composition to favour Norway spruce which will further increase probability of wind damage in the future. Therefore, we suggest that forest managers should consider the target forest species composition to mitigate wind risk if aimed to support production of log wood over the pulp. 
  

journal: "Forest Ecology and Management"
date: "`r Sys.Date()`"
#bibliography: mybibfile.bib
#bibliography: mendeley_mybibfile.bib
bibliography: manual.bib
#linenumbers: true
#numbersections: true
csl: elsevier-harvard.csl
output:
  bookdown::pdf_book:
    base_format: rticles::elsevier_article
#output: rticles::elsevier_article
#output: word_document
---

\newpage

Introduction
==========================

Future forest ecosystems need to simultaneously provide timber, non-woody ecosystem services such as carbon storage or human recreation, and shelter biodiversity.  Adaptive forest management strives to balance between timber production, provision of non-woody ecosystem services, and biodiversity. Existance of biodiversity, mostly attached to existence of deadwood, is limited by harvesting intensity. Intensive logging activities fragment forested landscapes. 
To balance between biodiversity and timber economic gains, the proportion of set-aside forests within commercial forests emerges, and new forest management approaches are explored, such as continuous forest cover [@Eyvindson2020] and traditional harvesting regimes are becoming controversial or requested to ban (…). The increase of the set aside forests within the commercial forests, as well as development of the new management techniques affect landscape level structural diversity, timing of the thinning, presence of absence of the final cuts in rotation forestry or development of the larger trees within continuous cover forestry or in set-aside forestry. The fundamental is the carefull landscape level planning of the management actions balancing between set-aside (unmanaged forests), intensive management and continuously present forest cover.

Optimal management scenarios fullfil the specific objectives of the society of forest owners to provide certain timber value, improve provision of timber and non-timber ecosystem services, or improve overall forest multifunctionality of the landscape. As such, optimization provides the combination of the specific forest management regimes on stand level. Althought the optimization process does not necessary involve the spatial configuration of the stands, it specifically assigns the particular regimes to individual stands and therefore allows to recreate alternative dynamics landscapes shaped by forest managements aggregated by optimal scenarios. As such, the spatial configuration of the management regimes allows to estimate the subsequent characteristics such as landscape level risk of wind damage. 

The risk of the wind damage increases with current climate change and it creates the major risk to the stability of the forest production. Windthrows are unpredictable climatic disruption that shapes forest structure and composition, and if left unsalvaged could create opportiunities for deadwood dependent species and support local biodiversity. From economical point of view, however, windthrows massively abrupt the continuity of the timber supply, lowers timber quality from log to pulp, increases the prices of unplanned salvage harvesting (REF). To lower the risk of wind risk damage, current suggestions include shortening the rotation period, promoting/avoiding the wind resistant vs. wind prone tree specuies, advocate for shortening of the minimal stand age (Latvia REF). This however poses further pressure on the multifucntionnal and multiple objective oriented landscapes, which will provide habitats for endangered species, support non-timber services and forest recreational use. 

Traditional forest management regimes specialized in promoting timber revenues while minimizing costs. In Fennoscandia, over the decades, the traditional rotation forestry with multiple thinnings and final cuts  that over just mutlipel decades (from 1950) homogenized stands structureal diversity, homogenized landscapes and increased forest fragmenetations. On the other hand, forest management supporting multifunctional landscapes, and promoting non-timber ecosystem services requires implementation of the diverse set of management regimes (Mönkkönen et al., 2014; Triviño et al., 2017). Furthermore, provision of the endangered species habitats and non-woody ecosystem services are provided on different scales where the planning scale should match or overcome the scale that provided ecosystem (Pohjanmies et al., 2019). 

Here we explore how the restriction of forest management practices, along with the increasing level of harvest levels over the landscape affects landscape level damage of wind risk and how much timber value is put on risk under alternative regimes and extraction levels. Our study for the first time evaluates the landcspeca level wind risk combined with the forest growth simulator and long-term consequences of he applied forest management practices. Therefore, we first calculate the stand level wind risk over alternative landscapes and further explore the likely drivers of the wind risk levels. We investigated how restriction of forest management regimes combined with levels of intensity of timber extraction will affects landscape level wind risk. 




Our study aims to understand how types of forest management and harvesting intensity affect stand and landcape level wind risk over time, and how much timber volume is at the risk at time.  We hypothetized that RF will increase stand level wind risk due accumulated timber volume before the final cut, and increase wind risk in landscape due to increasing number of stands with open edges after the final cuts. On the other hand, the CCF will likely homogenize the amount of timber volume over landscape; therefore at any given time, the exposed timber volume to wind damage will be lower in CCF compared to RF management. We wil consider the pulp and log volume of the standing volume. We futher investigate the dynamics of simulated stand characteristics as stand dominant height, dominant tree speciecs by stand, age, number of trees by stand, frequency of opend edge stands and thinning frequency over the landscape over the harvest intensity gradient and time. We further differentiate between the dynamics of the volume and wind risk in managed and set-aside forests.




Methods
==========================

```{r libraries, include = F}

knitr::opts_chunk$set(echo = FALSE, 
                      message=FALSE, 
                      warning=FALSE, 
                      dev="cairo_pdf", 
                      fig.width=7, fig.height=3.5)

```

### Study area 

Our study area represents a typical Finnish production forested landscape with relatively structurally homogenous forests stands. In total, we used 1475 forests stands aggregated within a single watershed (number 14.534) in Central Finland, covering 2242 ha (Fig. \ref{study_area}). Initial stand conditions were collected as open source data from the Finnish Forest Centre (available on www.metsaan.fi) providing currents stand conditions in 2016. 

![The study area located in Central Finland (watershed 14.534) comprising 1475 forest stands.\label{study_area}](/MyTemp/myGitLab/windDamage/externalFigs/studyArea_crop.png)

Our input dataset includes initial stand conditions (2016), alternative forest growth under the range of forest managemnet regimes over 100 years and a set of optimal solutions balancing between intensifying harvest levels and multifunctionnality (from completely set-aside, i.e. no management to maximal harvest gains). From the set of optimal solutions we have calculated stand-level probability of wind damage (for full details, please refer to @Eyvindson2020 study. Fig. \ref{workflow}) represents study workflow. 


![The study workflow from collecting initial stand conditions (2016) throught forest simulation growth under various ranges of forest management, and constriuction of teh harvesting intensity gradient using optimization to landscape level stand configurations.\label{workflow}](/MyTemp/myGitLab/windDamage/externalFigs/overview2_horizontal.png)



### Forest stand development under different regimes

We simulated the development of the forests stands using SIMO forest growth simulator [@rasinmaki2009] over 100 years, separated into 20 5-year sequences. Each stand could be managed by up to 58 different management regimes (the total number of regimes per stands depended on the initial stand conditions), including 17 regimes for rotation forestry (RF), 40 variations of continuous cover forest (CCF) and one set-aside (SA), where no management actions were taken. RF regimes differed in timing of final felling, optional thinning (present/absent), and increase in number of retained green trees after final cut (more details in @Eyvindson2018). Basic CCF management follows rules from @Aijala2014a. To increase the range of CCF managements, we varied two rules defining the timing of harvest: (i) site-specific basal area and (ii) timing of the first thinning. We modified the pre-defined site-specific basal area requirement (16m2/ha for less fertile sites to 22m2/ha for fertile sites) prior to harvesting by -3, ±0, +3, +6,  and delayed the timing of the first harvest in 5 year increments up to a delay of 45 years. 

### Optimization

The optimal forest management explores the trade-offs between net present income (NPI) and forest multifunctionality. NPI represents economic value of the forests estimated by Metsähallitus (the Finnish governmental organization managing state owned forests). Higher NPI presents higher timber extraction and opposes the proportion of the set-aside forest stands (i.e. without active harvesting) over the landscape. Optimization process over the NPI gradient was run using only RF, only CCF management types, or all possible managements (RF and CCF, further reffered as ALL) included over the gradient of NPI values, from 0 (representing completely set-aside or no management in all stands) to maximal amount of extracted timber (leaving up to 5% of SA stands). The optimization balances between harvest intensity and landscape-level multifunctionnality, including non-woody ecosystem services (climate change mitigation), recreational activities and vertebrate and non-vertebrate endangered species. The optimization resulted in 63 alternative collections of RF, CCF and ALL manamement regimes. We converted the optimal solutions back to the development paths for every stand under alternative management given group of management allowed (CCF, RF, ALL) and levels of timber extraction (21). Each stand has only one management regime by scenario. This allowed to reconstruct stand structure on particular stand under given management regime at specific time. 

### Wind risk calculation

We have calculated the probability of wind damage based on @Suvanto2019 binomial generalized linear model with logit-link function for each stand for every time step at each scenario. @Suvanto2019 model calculates the probability of the wind damage considering available relevant open-access datasets including dominant tree species, dominant tree height, time since thinning, predicted levels on maximal wind speed, temperature sums, evaluated if stand has open edge, soil type, mineral soil depth, site fertility and temperature sum (see @Suvanto2019 for all details). The final probability of wind damage shows relative differences between stands, whereas the damage can be only partial to the stand, but neglects the explicit spatial locations of the future strongs winds. The parameters of the dominant tree species, tree height, open edge and time since thinning were dynamics under simulated management regimes. Parameters of maximal predicted wind speed and temperature sums, as well as soil characteristics, remained stable during our 100 years simulation. We processed the datasets, calculated damage probability models, and visualized results using @RDevelopmentCoreTeam2019. 

### Data processing

We calculated the probability of wind damage for each stand, scenario and time intervals. Further, we averaged the wind risk values over the scenarios to allow comparison between RF, CCF and ALL management regimes groups over the harvesting gradient. We explored the mean wind risk (%) given the management groups and over harvest gradient (from set-aside to maximal harvest levels). In addition, we investigated the mean levels of the standing log and pulp timber volumes (m3) for scenarios, and total sum of harvested pulp and log timber over simulation run (XXX). We further investigated the changes in dynamics parameters (tree species, dominant tree height, frequency of open edges and time since thinning) over the harvest intensity gradient to understand how they contributed to predicted wind risk values. As different tree species varied in wind risk probability, we further groupped this variable by species to understand differences between species, Specifically, we calculated mean proportion of individual tree species (%),  mean tree heights (m), proportion of the stands with open edge from total amount of stands by species and mean thinning frequencies by year.  

Results
==========================
``` {r libs, eval = T, echo = F, warning = F, message = F, include = F}


rm(list = ls())


# Add this to your R code:
#.libPaths(c("/projappl/project_2003256/project_rpackages", #.libPaths()))
#libpath <- .libPaths()[1]

.libPaths(c("/projappl/project_2003256/project_rpackages", .libPaths()))


# , eval = FALSE
library(data.table)
library(dplyr)
library(raster)
library(ggplot2)
library(sf)
library(stringr)
library(gridExtra)
library(tidyr)
library(ggpubr)
library(RColorBrewer)
```

```{r set-my-theme, eval = T, echo = F, warning = F, message = F, include = F}

theme_set(theme_classic())
#theme_set(theme_grey())
theme_update(panel.grid.major = element_line(colour = "grey95",
                                             size = 0.1,
                                             linetype = 2),
             strip.background = element_rect(color="grey95", 
                                             fill="grey95",
                                             size=0.1, 
                                             linetype="solid"))

```

```{r process_input_data, eval = T, echo = F, warning = F, message = F, include = F}
# 
# setwd("C:/MyTemp/myGitLab/windDamage")
setwd("/projappl/project_2003256/windDamage")


# Read datasets:
# ----------------------------------------
#df <- fread("C:/MyTemp/myGitLab/windDamage/output/final_df.csv")
df <- fread(paste0(getwd(), "/output/final_df.csv"))

# stands geometry
df.geom <- st_read(paste0(getwd(),"/14.534/14.534/mvj_14.534.shp"))

#df.geom <- st_read("C:/MyTemp/avohaakut_db/14.534/14.534/mvj_14.534.#shp")

df.geom <- subset(df.geom, select = c("KUVIO_ID"))
names(df.geom) <- c("id", "geometry")
df.geom$area <- st_area(df.geom)
df.geom <- subset(df.geom, id %in% unique(df$id))

# Total area of watershed:
tot.area = as.numeric(sum(df.geom$area))

```



### Wind damage probability 

The level of wind risk remain the same with increasing harvest intensity, while it is two time higher in CCF then in RF (Fig.3). In set-aside stands is stabel until 5K EUR by ha, while afterwards increases. This might be because of the selection of the less profitalne stands as set-aside forests while increasing timber profits. Over time, the probability of wind risk increases in CCF and RF management and culminates towards the end of the simulation period, and in RF it sharply decreases (FIG). the wind risdk in ciompletely set-aside forests almost double over time.  \@ref{fig_meanRisk_time_NPI}

``` {r fig_meanRisk_time_NPI, fig.width = 7, fig.height = 3, fig.cap = "\\label{fig:fig_meanRisk_time_NPI} Mean wind risk damage for three types of management regimes over A: harvest intensity gradient and B: over time."}

# Wind risk over NPI
p.mean.risk.npi <- 
  df %>% 
  group_by(scenSimpl2, scenNumb, NPI, twoRegm) %>% 
  summarize(mean.m = mean(windRisk)) %>% 
  ggplot(aes(x = NPI,
             y = mean.m,
             group = scenSimpl2)) + # ,
  geom_line(aes(linetype = scenSimpl2, 
                color    = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") +
  #scale_color_grey() +
  ylim(0, 0.06)+
  xlab("NPI k € by ha") + #  
  ylab("mean wind risk damage (%)") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "bottom") +
  ggtitle("A") +
  facet_grid(.~ twoRegm)


p.mean.risk.time <- 
  df %>% 
  group_by(scenSimpl2,year, twoRegm) %>% #  scenNumb,
  summarize(mean.m = mean(windRisk)) %>% 
  ggplot(aes(x = year,
             y = mean.m,
             group = scenSimpl2)) + # ,
  geom_line(aes(linetype = scenSimpl2, 
                color    = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") +
  ylim(0, 0.06)+
  xlab("Time") + #  
  ylab("mean wind risk damage (%)") +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5),
        legend.position = "bottom") +
  ggtitle("B") +
  facet_grid(.~ twoRegm)


ggarrange(p.mean.risk.npi, 
          p.mean.risk.time, 
          ncol = 2, nrow = 1,
          common.legend = TRUE, legend="bottom")



```

### Timber volume at wind risk

<<<<<<< HEAD
All three types of management groups responds similarly to set-aside stands: stading timber volume decreases in set-aside stands, which corresponds to preferential selection of the low quality stands to be set as set-aside at the beginning of teh simulation period. Standing mean log timber volume slightly increases with harvesting intensity where increases from  50m3 to 75m3 with the highest increase in RF. In set aside stands, the highest mean top stratum timber volume starts as 150 m3 and lowers to 50 m3/ha with increasing harvest intensity. In pulp wood,RF has three times higher pulp volume compared to CCF as low harvest intensities, the pulp volume in CCF remains relatively stable with increasing harvest intensity.    
=======
All three types of management groups responds similarly to set-aside stands: stading timber volume decreases in set-aside stands, which corresponds to preferential selection of the low quality stands to be set as set-aside at the beginning of teh simulation period. Standing mean log timber volume slightly increases with harvesting intensity where increases from  50m3 to 75m3 with the highest increase in RF. In set aside stands, the highest mean top stratum timber volume starts as 150 m3 and lowers to 50 m3/ha with increasing harvest intensity. In pulp wood,RF has three times higher pulp volume compared to CCF as low harvest intensities, the pulp volume in CCF remains relatively stable with increasing harvest intensity. Over time, the log volume culminates in RF in year 2100 to up to 150 m3 in to top layers, while remaines halved in CCF, whereas the pulp volume starts at the same levels for CCF and RF in 2016 and in next 40 years (from 2060) in RF dominates the proportion of teh pulp wood over the CCF. Overall, the log timber in in SA stands increases over time, as they were not logged, and sligtthly decreases in teh amount of pulp wood. 

>>>>>>> f35d670dc2a261f9f3c05ed566417244429b0dc8

```{r plot_V_timber, fig.width = 6, eval=F, fig.height = 6, fig.cap = "A. Mean standing and B. harvested pulp and log timber under three types of management regimes over harvest intensity gradient. Please note the range of y axis"}

# -----------------------------------------
# Visualize volume dynamics over scenarios
# -----------------------------------------


# -------------------------------------------
# plot sum of different volumes over x
# -------------------------------------------
# For harvested V - calculate sum, as this is not measured every time,
# otherwise calculate mean or max???


# Calculate means& sum volumes using summarize: faster then 'aggregate()'
V_st_log_mean   <- df %>% 
                      group_by(scenSimpl2, NPI) %>%
                            summarize(V_st_log_mean = 
                                        mean(V_stand_log, na.rm = T))

V_st_pulp_mean  <- df %>% 
                      group_by(scenSimpl2, NPI) %>%
                            summarize(V_st_pulp_mean = 
                                        mean(V_stand_pulp, na.rm = T))

V_harv_log_sum  <- df %>% 
                      group_by(scenSimpl2, NPI) %>%
                            summarize(V_harv_log_sum =
                                        sum(Harvested_V_log_under_bark, na.rm = T))

V_harv_pupl_sum <- df %>% 
                      group_by(scenSimpl2, NPI) %>%
                            summarize(V_harv_pupl_sum =
                                        sum(Harvested_V_pulp_under_bark, na.rm = T))


# Calculate mean& sum volumes using aggregate: slow
# ---------------------------------
#V_st_log_mean   <- aggregate(V_stand_log ~ scenSimpl2 +  NPI, df, mean)
#V_st_pulp_mean  <- aggregate(V_stand_pulp ~ scenSimpl2 +  NPI, df, mean)

#V_harv_sum      <- aggregate(Harvested_V ~ scenSimpl2 +  NPI, df, sum)
#V_harv_log_sum  <- aggregate(Harvested_V_log_under_bark ~  scenSimpl2 +  NPI, df, sum)
#V_harv_pupl_sum <- aggregate(Harvested_V_pulp_under_bark ~  scenSimpl2 +  NPI, df, sum)


# Merge data into one table
all.V <-# V_mean %>% 
  V_st_log_mean %>% 
  left_join(V_st_pulp_mean) %>% 
 # left_join(V_harv_sum) %>% 
  left_join(V_harv_log_sum) %>% 
  left_join(V_harv_pupl_sum)


# Try to melt the data???
all.V_melt <- reshape2::melt(all.V, id.vars = c('NPI', 'scenSimpl2'))

# Add new variable: stand or harvested
all.V_melt <- all.V_melt %>% 
  mutate(type = case_when(
    stringr::str_detect(variable, "V_harv_") ~ "harvested",
   TRUE ~ "stand"))



# Create two plots, merge later into one
p.stand <- 
  all.V_melt %>% 
  filter(type == "stand" ) %>% # & variable != "V" 
  ggplot(aes(x = NPI,
                       y = value,
                       group = scenSimpl2,
                       color = scenSimpl2)) +
 geom_line(aes(linetype = scenSimpl2, 
                color    = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("NPI k € by ha") +
  ylab("mean stand volume (m3)") +
  facet_wrap(.~ variable) + 
  ggtitle("A") 



p.harvested <- 
  all.V_melt %>% 
  filter(type == "harvested" ) %>%  # & variable != "Harvested_V"
  ggplot(aes(x = NPI,
             y = value/10000,
             group = scenSimpl2,
             color = scenSimpl2)) +
    geom_line(aes(linetype = scenSimpl2, 
                color    = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") +
  xlab("NPI k € by ha") +
  ylab("sum harvested volume (*1000)") +
  facet_wrap(.~ variable) +
  ggtitle("B")


ggarrange(p.stand, p.harvested, ncol = 1, nrow = 2,
          common.legend = TRUE, legend="bottom")
```

The intensification of the harvesting levels increases the proportion of the pulp wood compared to log wood, especially in RF. In CCF, the proportion among standing log and pulp volume remains at the same rate (65:30) where the production of the log timber dominates. At the highest intensity of timber extraction, pulp wood creates up to 50% of teh total standing volume See figure  \@ref(fig:proportion_V_pulp_log) NEW FIG \@ref(proportion_V_pulp_log).


``` {r replace-na, eval = F}

# replace all NA in volume by 0 - because not volume is available there
df<- 
  df %>% 
  dplyr::mutate(V_stand_log = replace_na(V_stand_log, 0)) %>% 
  dplyr::mutate(V_stand_pulp = replace_na(V_stand_pulp, 0)) %>% 
  dplyr::mutate(V_strat_max = replace_na(V_strat_max, 0)) %>% 
  dplyr::mutate(V_strat_max_log = replace_na(V_strat_max_log, 0)) %>% 
  dplyr::mutate(V_strat_max_pulp = replace_na(V_strat_max_pulp, 0)) %>% 
  dplyr::mutate(Harvested_V_log_under_bark = replace_na(Harvested_V_log_under_bark, 0)) %>% 
  dplyr::mutate(Harvested_V_pulp_under_bark = replace_na(Harvested_V_pulp_under_bark, 0)) 
  
```

In spruce dominated forests, the proportion of the log wood from top stratum lowers by 50% with increasing harvesting rate in all management regimes applied. Interestingly, RF maintains the high production of the pulp wood with increasing harvest intensity. For all species, the proportion of the stand and top stratum volumes lowers by `r round(80/170*100)`% (spruce, RF), while pulp lowers in CCF and ALL management (`r round(40/97*100)`) and remained the same (mean 100 m3/ha)in RF with increasing harvesting rates.    

```{r V-stand-stratum, fig.width= 7, fig.height = 6, fig.cap="Mean log (left) and pulp (right) timber volume of the top tree layer in the stands over management groups over harvesting intensity gradient (top) and over years (bottom)"}
# CReate a function to store all small details of teh plots

plot_details <- function() {
  list( 
    geom_line(aes(linetype = scenSimpl2, 
                  color = scenSimpl2),
            lwd = 0.8),
    scale_color_brewer(palette="Greens"),
    labs(color = "Scenario",
        linetype = "Scenario"), # geom_line(size = 1) + 
  #  xlab("NPI k € by ha"), # +
  #  ylab("stand V (m3)"), #+
    ylim(0, 220),
    facet_wrap(.~ twoRegm), # + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "bottom"), # +
    ggtitle("") )
}


# plot the % of the stratum volume from the total volume 

# The highest stratum volume
# V.strat.df <- 
#   df %>%
#   group_by(NPI, scenSimpl2, twoRegm) %>% 
#   summarize(V_mean = mean(V_strat_max, na.rm = T)) #%>% 
# 
# V.strat <-  
#   ggplot(V.strat.df, 
#          aes(x = NPI,
#              y = V_mean, #/10,             group = scenSimpl2,
#              color = scenSimpl2)) + 
#   plot_details() +
#   xlab("NPI k € by ha")
# 

# The highest stratum volume: LOG
V.strat.log.npi <- 
  df %>%
  group_by(NPI, scenSimpl2, twoRegm) %>% 
 summarize(V_mean = mean(V_strat_max_log, na.rm = T)) %>% 
  ggplot(aes(x = NPI,
             y = V_mean, #/10,             group = scenSimpl2,
             color = scenSimpl2)) +
  ylab("log timber V (m3)") +
  xlab("NPI k € by ha") + 
  plot_details()



# The highest stratum volume: LOG
V.strat.pulp.npi <-
  df %>%
  group_by(NPI, scenSimpl2, twoRegm) %>% 
  summarize(V_mean = mean(V_strat_max_pulp, 
                          na.rm = T)) %>% 
  ggplot(aes(x = NPI,
             y = V_mean, #/10,             group = scenSimpl2,
             color = scenSimpl2)) +
  ylab("pulp timber V (m3)") +
  plot_details()



# Get volume development over years

# The highest stratum volume: LOG
V.strat.log.year <- 
  df %>%
  group_by(year, scenSimpl2, twoRegm) %>% 
 summarize(V_mean = mean(V_strat_max_log, na.rm = T)) %>% 
  ggplot(aes(x = year,
             y = V_mean, #/10,             group = scenSimpl2,
             color = scenSimpl2)) +
  ylab("log timber V (m3)") +
  xlab("NPI k € by ha") + 
  plot_details()



# The highest stratum volume: LOG
V.strat.pulp.year <-
  df %>%
  group_by(year, scenSimpl2, twoRegm) %>% 
  summarize(V_mean = mean(V_strat_max_pulp, 
                          na.rm = T)) %>% 
  ggplot(aes(x = year,
             y = V_mean, #/10,             group = scenSimpl2,
             color = scenSimpl2)) +
  ylab("pulp timber V (m3)") +
  plot_details()


# Plot both plots: stand volume and highest stratum volume
# ---------------------
<<<<<<< HEAD
ggarrange(V.strat.log.npi,  V.strat.pulp.npi, 
          V.strat.log.year, V.strat.pulp.year, #V.strat, 
          ncol = 2, nrow = 2,
=======
ggarrange(p.mean.risk.npi, p.mean.risk.time,
          V.strat.log.npi,  V.strat.pulp.npi, 
          V.strat.log.year, V.strat.pulp.year, #V.strat, 
          ncol = 2, nrow = 1,
>>>>>>> f35d670dc2a261f9f3c05ed566417244429b0dc8
          common.legend = TRUE, legend="bottom")


```

```{r timber_volume_stand, eval = F}


# Total stand volume
# ----------------------------

V.stand.log <- 
  df %>%
  group_by(NPI, scenSimpl2, twoRegm) %>% 
  summarize(V_mean = mean(V_stand_log, na.rm = T)) %>% 
  ggplot(aes(x = NPI,
             y = V_mean, #/10,             group = scenSimpl2,
             color = scenSimpl2)) +
  ylab("stand V log (m3)") +
  plot_details()


# Total stand volume
V.stand.pulp <- 
  df %>%
  group_by(NPI, scenSimpl2, twoRegm) %>% 
  summarize(V_mean = mean(V_stand_pulp, na.rm = T)) %>% 
  ggplot(aes(x = NPI,
             y = V_mean, #/10,
             group = scenSimpl2,
             color = scenSimpl2)) +
  ylab("stand V pulp (m3)") +
  plot_details()


# Total stand volume
V.stand.df <- 
  df %>%
  group_by(NPI, scenSimpl2, species) %>% 
  summarize(V_mean = mean(V, na.rm = T)) #%>% 

V.stand <-
  ggplot(V.stand.df,
         aes(x = NPI,
             y = V_mean, #/10,
             group = scenSimpl2,
             color = scenSimpl2)) +
   plot_details()


# For 'other' species, there are no 'other' as main species for RF and CCF?
# No, there are not

# # Plot both plots: stand volume and highest stratum volume
# # ---------------------
# ggarrange(#V.stand.log, V.stand.pulp, #V.stand, 
#           V.strat.log.npi, V.strat.pulp.npi, #V.strat, 
#           ncol = 2, nrow = 2,
#           common.legend = TRUE, legend="bottom")

# why there are sometimes NA values in 'other' = shouwl it be 0??
#filter(df, is.na(V_strat_max))


# how much top stratum V is from the total volume in RF, CCF and ALL?


```


```{r proportion_V_stand_strat, eval = F, fig.width = 4, fig.height=3, fig.cap = "Mean proportion of the top stratum volume from the totatl stand volume by management groups and harvest intensity." }

df.V <- 
  V.stand.df %>% 
  left_join(V.strat.df, 
            by = c("NPI", "scenSimpl2", "species")) %>% 
  mutate(propV = V_mean.y/V_mean.x * 100)


# How does the % between the top layer and stand volume changes with 
# increasing harvest intensity and management regimes???

ggplot(df.V,
         aes(x = NPI,
             y = propV, #/10,
             group = scenSimpl2,
             color = scenSimpl2)) +
   plot_details() +
     ylim(0,100) +
  ylab("mean % top V from\ntotal stand V")



```



```{r proportion_V_pulp_log, eval = F, echo = F, warning = F, message = F, fig.width = 4, fig.height = 2, fig.cap = "Ratio between standing log and pul volume (m^3)"}
# Here is te question: does the harvest intensification changes the proportion between log and pulp wood???

# V_sum          <- aggregate(V ~ scenSimpl2 +  scenNumb, df, sum)
# V_st_log_sum   <- aggregate(V_stand_log ~ scenSimpl2 +  scenNumb, df, sum)
# V_st_pulp_sum  <- aggregate(V_stand_pulp ~ scenSimpl2 +  scenNumb, df, sum)
# 
# 
# # Merge two sum of the pulp and log 
# # tables and calculate the proprtions:
# 
# V.prop <- 
#   V_st_log_sum %>% 
#   left_join(V_st_pulp_sum) %>% 
#   mutate(V_total     = V_stand_log + V_stand_pulp) %>% 
#   mutate(V_log_prop  = V_stand_log/V_total * 100) %>% 
#   mutate(V_pulp_prop = V_stand_pulp/V_total * 100) %>% 
#   dplyr::select(-c(V_stand_log, V_stand_pulp, V_total)) 
# 
# 
# 
# # Convert data from long to wide format
# V.prop.l <- reshape2::melt(V.prop, id.vars = c("scenSimpl2", 
#                                               # "NPI", 
#                                                "scenNumb"))

# Plot proportion of teh timber volume based on type

# V.prop.l %>% 
#   ggplot(aes(x = scenNumb,
#              y = value,
#              fill = variable)) +
#   geom_bar(position="stack", 
#            stat="identity",
#            width = 0.5) +
#   facet_grid(.~ scenSimpl2) +
#   scale_fill_grey(start = 0.8, end = 0.2) +
#   ylab("Ratio standing\nlog:pulp timber volume") + 
#   xlab("Harvest intensity") +
#    labs(fill = "Timber volume type") 
  

```




### Changes in wind risk

```{r fig_windRisk_time_change, eval = F, fig.width = 4, fig.height = 2.5, fig.cap = "Landscape level changes in wind risk over time"}

# How does the wind risk vary over time? can vary over the stands, over the landscapes
# calculate mean wind risk by landscape, get differences in wind risk
# over years, plot those differences as means by scenarios - over harvest gradient

df_l_mean <- df %>%
  group_by(NPI, scenSimpl2, year) %>%
  summarize(mean_risk_landscape = mean(windRisk)) %>% 
  mutate(windRisk_diff = mean_risk_landscape - lag(mean_risk_landscape))


# Plot using boxplots to show all variability between years
ggplot(df_l_mean, 
       aes(x = as.factor(NPI),
           y = windRisk_diff,
           group = as.factor(NPI))) +
  geom_boxplot() + 
  xlab("NPI k € by ha") +
  ylab("between years changes in\nwind risk") +
  facet_wrap(.~ scenSimpl2) + 
  theme(legend.position = "bottom") +
  ggtitle("") 

```


```{r, windRisk_temporal_landscape, eval = F}
# Calculate temporal change in wind risk on stand level
# ------------------
df %>%
  arrange(id, scenSimpl2, NPI) %>% 
  #group_by(NPI, scenSimpl2, year, id) %>%
  dplyr::select(id, year, NPI, scenSimpl2, windRisk) %>% 
  mutate(risk_diff = windRisk - lag(windRisk)) %>% 
  ggplot( 
       aes(x = as.factor(NPI),
           y = risk_diff,
           group = as.factor(NPI))) +
  geom_boxplot() + 
  xlab("NPI k € by ha") +
  ylab("yearly differences") +
  #ylim(0, 55) +
  facet_wrap(.~ scenSimpl2) + 
  theme(legend.position = "bottom") +
  ggtitle("") 




```

```{r, windRisk_temporal_stand, eval = F}
# Plot using boxplots to show all variability between years
ggplot(df_l_mean, 
       aes(x = as.factor(NPI),
           y = windRisk_diff,
           group = as.factor(NPI))) +
  geom_boxplot() + 
# geom_line(aes(linetype = scenSimpl2, 
#              color    = scenSimpl2),
 #          lwd = 0.8) +
#  scale_color_brewer(palette="Greens") +
#  labs(color = "Scenario",
#       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("NPI k € by ha") +
  ylab("mean yearly differences") +
  #ylim(0, 55) +
  facet_wrap(.~ scenSimpl2) + 
  theme(legend.position = "bottom") +
  ggtitle("") 




# get the mean values of differences between scenarios

df_scen_mean <- aggregate(windRisk_diff ~ NPI + scenSimpl2, 
                          df_l_mean, mean)

# plot the mean differences in yearly changes

ggplot(df_scen_mean, 
       aes(x = NPI,
           y = windRisk_diff,
           group = scenSimpl2,
           color = scenSimpl2)) +
 geom_line(aes(linetype = scenSimpl2, 
              color    = scenSimpl2),
           lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("NPI k € by ha") +
  ylab("mean yearly differences") +
  #ylim(0, 55) +
  #facet_wrap(.~ species) + 
  theme(legend.position = "bottom") +
  ggtitle("") 



```


## Dynamic parameters contributing to wind risk

### Species composition

The intensification of the harvesting changes the stand species composition over time (Fig. \ref{species_change}). Intensification of the harvesting favorize the proportion of the Norway spruce and others (deciduous) tree species instead of Scots pine, which likely in turn increases wind risk over the stands. Proportion of the pine lowers with higher harvest intensities.     

```{r species_change, eval = T, echo = F, warning = F, message = F, fig.width = 7, fig.height = 3.5, fig.cap = "Changes in species composition under different management groups and harvest intensity."}

# get mean count for each species over SA gradient - plot over SA gradient

df %>%
  group_by(NPI, scenSimpl2, species) %>% 
  tally() %>% 
  ggplot(aes(x = NPI,
             y = n/29400*100,
             group = scenSimpl2,
                       color = scenSimpl2)) +
 geom_line(aes(linetype = scenSimpl2, 
                color    = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("NPI k € by ha") +
  ylab("stands (%)") +
  ylim(0, 55) +
  facet_wrap(.~ species) + 
  theme(legend.position = "bottom") +
  ggtitle("") 
  


```

### Dominant tree heights 

The intensification of the harvest reduce mean tree height for other species to half (from 20 m  to 10 m) in RF, while CCF slightly increases mean tree heights.For pine and spruce trees, harvest intensification maintain the mean tree height of the stand to 20 m(other) to 22 m (spruce). Spruce is higher then pine and other stree species.   

```{r res_D_tree_height, eval = T, echo = F, warning = F, message = F, fig.width = 7, fig.height = 3.5, fig.cap = "Mean dominant tree height under different management groups and harvest intensity."}

# get mean count for each species over SA gradient - plot over SA gradient

df %>%
  group_by(NPI, scenSimpl2, species) %>% 
  mutate(H_mean = mean(H_dom)) %>% 
  ggplot(aes(x = NPI,
             y = H_mean/10,
             group = scenSimpl2,
             color = scenSimpl2)) +
 geom_line(aes(linetype = scenSimpl2, 
                color   = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("NPI k € by ha") +
  ylab("tree height (m)") +
  ylim(0, 25) +
  facet_wrap(.~ species) + 
  theme(legend.position = "bottom") +
  ggtitle("") 

```

```{r mean_stand_age, eval = F}

df %>%
  group_by(NPI, scenSimpl2, species) %>% 
  mutate(age_mean = mean(Age)) %>% 
  ggplot(aes(x = NPI,
             y = age_mean,
             group = scenSimpl2,
             color = scenSimpl2)) +
 geom_line(aes(linetype = scenSimpl2, 
                color   = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("NPI k € by ha") +
  ylab("Mean stand age") +
  ylim(0, 105) +
  facet_wrap(.~ species) + 
  theme(legend.position = "bottom") +
  ggtitle("") 


```
### Tree count

```{r mean_tree_n, eval = T}

df %>%
  group_by(NPI, scenSimpl2, species) %>% 
  mutate(tree_n = mean(N)) %>% 
  ggplot(aes(x = NPI,
             y = tree_n,
             group = scenSimpl2,
             color = scenSimpl2)) +
 geom_line(aes(linetype = scenSimpl2, 
                color   = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("NPI k € by ha") +
  ylab("Mean # tree by stand") +
  ylim(0, 4000) +
  facet_wrap(.~ species) + 
  theme(legend.position = "bottom") +
  ggtitle("") 


#range(df$N)
#hist(df$N)

```



```{r wind_risk_SA}

# Calculate teh mean wind risk between SA/no_SA regimes over RF, CCF, ALL and harvest int

p.risk.NPI <- df %>%
  group_by(NPI, scenSimpl2, twoRegm) %>% 
  summarize(wRisk_mean_SA = mean(windRisk, na.rm = T)) %>% 
  ggplot(aes(x = NPI,
             y = wRisk_mean_SA,
             group = scenSimpl2,
             color = scenSimpl2)) +
 geom_line(aes(linetype = scenSimpl2, 
                color   = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("NPI k € by ha") +
  ylab("Mean wind risk") +
  ylim(0, 0.05) +
  facet_wrap(.~ twoRegm) + 
  theme(legend.position = "bottom") +
  ggtitle("") 


# Get wind risk over years
p.risk.year <- df %>%
  group_by(year, scenSimpl2, twoRegm) %>% 
  summarize(wRisk_mean_SA = mean(windRisk, na.rm = T)) %>% 
  ggplot(aes(x = year,
             y = wRisk_mean_SA,
             group = scenSimpl2,
             color = scenSimpl2)) +
 geom_line(aes(linetype = scenSimpl2, 
                color   = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("Years") +
  ylab("wind risk\n(%, mean)") +
  ylim(0, 0.07) +
  facet_wrap(.~ twoRegm) + 
  theme(legend.position = "bottom") +
  ggtitle("") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 



# CHeck the age/volume over years

# p.age.years <- df %>%
#   group_by(year, scenSimpl2, twoRegm) %>% 
#   summarize(wRisk_mean_SA = mean(Age, na.rm = T)) %>% 
#   ggplot(aes(x = year,
#              y = wRisk_mean_SA,
#              group = scenSimpl2,
#              color = scenSimpl2)) +
#  geom_line(aes(linetype = scenSimpl2, 
#                 color   = scenSimpl2),
#             lwd = 0.8) +
#   scale_color_brewer(palette="Greens") +
#   labs(color = "Scenario",
#        linetype = "Scenario") + # geom_line(size = 1) + 
#   xlab("Years") +
#   ylab("Mean wind risk") +
# #  ylim(0, 4000) +
#   facet_wrap(.~ twoRegm) + 
#   theme(legend.position = "bottom") +
#   ggtitle("") 



# check the development of the volume
p.V.years <- 
  df %>%
  group_by(year, scenSimpl2, twoRegm) %>% 
  summarize(wRisk_mean_SA = mean(V_strat_max, na.rm = T)) %>% 
  ggplot(aes(x = year,
             y = wRisk_mean_SA,
             group = scenSimpl2,
             color = scenSimpl2)) +
 geom_line(aes(linetype = scenSimpl2, 
                color   = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("Years") +
  ylab("top stratum volume\n(m3, mean)") +
 ylim(0, 290) +
  facet_wrap(.~ twoRegm) + 
  theme(legend.position = "bottom") +
  ggtitle("") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 


ggarrange(#p.risk.NPI, 
          p.risk.year, p.V.years,
          nrow = 2, ncol = 1,
          common.legend = TRUE, legend="bottom")




```



```{r sample_data, eval = F}

# Sample  random rows:
set.seed(1)
sample_row <- sample(1:nrow(df), 100000, replace=F)
df.sample <- df[sample_row,]

# how does age changes with tree numbers???

ggplot(df.sample, aes(x = N,
                      y = Age,
                      group = scenSimpl2,
                      color = scenSimpl2)) +
  geom_point() + 
  facet_grid(.~scenSimpl2)
  



```

```{r age_geom_density, eval = F}
library(ggridges)

ggplot(df.sample, 
       aes(x = N,
           y = as.factor(scenNumb))) +
  geom_density_ridges(rel_min_height = 0.01) + # remove tails (repcent cutoff)
  facet_grid(.~ scenSimpl2 )


# Try for volume
ggplot(df.sample, 
       aes(x = V,
           y = as.factor(scenNumb))) +
  geom_density_ridges(rel_min_height = 0.01) + # remove tails (repcent cutoff)
  facet_grid(.~ scenSimpl2 )


# Check changes in volume over time
ggplot(df.sample, 
       aes(x = V,
           y = as.factor(year))) +
  geom_density_ridges(rel_min_height = 0.01) + # remove tails (repcent cutoff)
  facet_grid(.~ scenSimpl2 )


# Try density of the wind risk over time

# Check changes in volume over time
ggplot(df.sample, 
       aes(x = windRisk,
           y = as.factor(year))) +
  geom_density_ridges(rel_min_height = 0.01) + # remove tails (repcent cutoff)
  facet_grid(.~ scenSimpl2 )




# Wind risk over SA scenarios

# Check changes in volume over time
ggplot(df.sample, 
       aes(x = windRisk,
           y = as.factor(scenNumb))) +
  geom_density_ridges(rel_min_height = 0.01) + # remove tails (repcent cutoff)
  facet_grid(.~ scenSimpl2 )


# DOes the increasing volume increase wind risk?? e
ggplot(df.sample, 
       aes(x = windRisk,
           y = V_strat_max,
           group = scenSimpl2)) +
  geom_point() + # remove tails (repcent cutoff)
  facet_grid(.~ scenSimpl2 )





# get a scatter plot of teh wind risk X volume by groups:
# how to show that RF has lower risk, because it just simply does not have trees????
df.sample %>% 
  filter(scenNumb == "10") %>% 
  ggplot(#df.sample, 
       aes(x = V,
           y = windRisk, color = species)) +
  geom_point(size = 0.1, alpha = 0.2) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  #geom_density_ridges(rel_min_height = 0.01) + # remove tails (repcent cutoff)
  facet_grid(scenSimpl2 ~ scenNumb)



```





### Frequency of open stands

The proportion of the open edge stands remains very high over whole simulation run, which is likely due to the fragmeneted landscape (85-95% of stands by species, Fig. 2, Fig. XX). However, increasing harvest intensity lowers number of stands with open edge when dominated by other species, whereas increases those numbers for pine and spruce dominated spatnd, especially under RF. The CCF and ALL management groups maintain the number of the open edge stands similar to completely set aside stands.   
   

```{r fig_6_count_open_edge, eval = T, echo = F, warning = F, message = F, fig.width = 7, fig.height = 3.5, fig.cap = "Yearly proportion stands with open edge by species, management group and over the harvest intensity gradient. Note y axis starts at 80."}

# calculate this as a proportion of teh open edge stands from teh number of available stands for particular species????

# Ca;culate how many stand have which species
df_n_species <-
  df %>% 
  group_by(scenSimpl2, NPI, species) %>% 
  #filter(open_edge == TRUE) %>% 
  tally() %>% 
  rename(species_n = n)

# Plot open_edge FALSE = (closed stand) over SA %
# ---------------------
df %>% 
  group_by(scenSimpl2, NPI, open_edge, species) %>% 
  filter(open_edge == TRUE) %>% 
  tally() %>% 
  left_join(df_n_species) %>% 
  mutate(prop_spec = n/species_n*100) %>% 
   ggplot(aes(x = NPI, #factor(scenNumb),
             y = prop_spec,  # number of stands by one year
             color = scenSimpl2,
             group = scenSimpl2)) + # ,
   geom_line(aes(linetype = scenSimpl2, 
                color    = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") +
  ylim(80, 100) +
  xlab("NPI k € by ha") + 
  facet_grid(.~species) +
  ylab("open edge stands (%)") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "bottom") +
  ggtitle("") 







```



### Thinning frequency

the highest frequency of thinnings is under CCF management regimes, which lineraly increase with harvesting intensity for all tree species. Numbers of thinnings in RF remains relatively low comparing to CCF and ALL, and strongly increases at high harvest intensity (from 3K for pine and from 5K for spruce). The frequency of thinnings in CCF increases 3-4 times in CCF comparing to RF. 

```{r, eval = F}

mydf <- data.frame('col_1'=c('A','A','B','B', 'B'), 
                   'col_2'=c(100,NA, 90,30, 100))

mydf %>% 
  group_by(col_1) %>% 
  summarise(non_na_count = sum(!is.na(col_2)))

```



```{r fig_thin_frequency, eval = T, echo = F, warning = F, message = F, fig.width = 7, fig.height = 4, fig.cap = "The frequency of the thinnings by management groups, species and harvest intensity gradient"}

# Identify the number of the non NA record of teh thinning actuons
# if thinning occurs, it is represented by the non-na string
# works on dummy datasets, try on specidic id
# calculate frequency of thinnings by scenarios, devide by 20 to have mean over 20 years

#head(df)

# HOw many times there is a record in THIN???
# how to recscale it? to stand, to landscape??


df$THIN2 <- df$THIN

df$THIN2[df$THIN2==""]<-NA


# Calculate the number of non NA values by groups
#df %>% 
#  filter(avohaakut == "LRT5" & id == "12541249" &scenSimpl2 == "ALL" & scenNumb == "10") %>% 
  #distinct(landscape)
#  dplyr::select(id, year, THIN, THIN2, landscape) %>% 
#   summarise(non_na_count = sum(!is.na(THIN2)))

```

```{r, eval = T}

# Calculate the number of non NA values by groups
df %>% 
  group_by(scenSimpl2, NPI, species) %>% 
  summarise(non_na_count = sum(!is.na(THIN2))) %>% 
  ggplot(aes(x = NPI, #factor(scenNumb),
             y = non_na_count/20,  # number of stands by one year
             color = scenSimpl2,
             group = scenSimpl2)) + # ,
   geom_line(aes(linetype = scenSimpl2, 
                color    = scenSimpl2),
            lwd = 0.8) +
  scale_color_brewer(palette="Greens") +
  labs(color    = "Scenario",
       linetype = "Scenario") +
  #ylim(0, 700) +
  xlab("NPI k € by ha") + 
  facet_grid(.~species) +
  ylab("Mean # of thinned stands (year/landscape)") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1),
        legend.position = "bottom") +
  ggtitle("") 
  
# count non-na values

```



 
Discussion
==========================


### Wind risk dynamics

We found that intensification of the harvesting regimes have different conseuqences of resulting wind risk: where CCF management increases wind risk, and RF lowers wind risk with increasing intensity.  

### Wind risk drivers

### Future questions to answer


### Recommendation for future management

- SA vs. intensification of management
- management types: CCF, RF or ALL or something else???




Wind (10 years return level of max wind speed REF) are estimated the same over 100 years as well as temperature sums. How does could affects the results?

In spite of inherent stochasticity of the wind and damage phenomena at all spatial scales can be successfully modelled combining spatial spatial datasets and ground earth observation data (Suvanto et al. 2019).
Interpret Suvanto’s map: there are 3 limitations: 
use values as relative to each other  - instead of exact probability valuesm, interpret the map as relative differences in damage vulnerability
Damage probabilities do not refer to complete damage of the stand – damage can be only poartial, in some part of the stand (not spatially expicit)
map erepresent the forest vulnerability to the wind, but it is impossible to predict the exact locations of future wind disturbances, given uncertainities in future wind occurences

- the glm takes into account the dominant tree species but neglects the stand structure. WE neglected the stand structure in applying the raster level based glm model to stand level information
- difficult to link the predicted wind risk to explicit wind damage volume as windthrows are unpredictanvle events in time and explicit locations.
- We need to understand what risks about current management decisions involves and if they bring another challenges, such as increasing risk of wind damage. On the other hand, the set-aside stands, if protected, teh wind damage there should not be regarded as lost timber volume due to windthrow, as was not supposed to be logged anyway. Howvere, if windthrow happen in SA stands, the risk of subsequent disturbances such as *Ips typographus*  might increase the cost of the effective stand protection in following years.
- SA forests have clearly higher wind risk than intensively managemed forests under RF. However, RF as highly specialized in provision of teh single benefit - timber - while deterioration non-woody ecosystem servoices and destroyng habitats for endangered species should be largely replaced over the landscapes by managements fulfillings multiple benefits @Eyvindson2020. 
- 

The shortening of the rotation period in Norway spruce forets  might slightly lower the wind and subsequent bark beetle distudrabnces but has limited efficiencies and decreses under climate change [@Zimova2020]





Conclusion
==========================


\newpage

# References {#references .unnumbered}



