---
title: "Supplementary material for wind risk paper"
author: "maycca"
date: "9/2/2020"
output: pdf_document
---


```{r set-dir, include = FALSE}
#require("knitr")
#opts_knit$set(root.dir = "/projappl/project_2003256/windDamage") #

```


```{r libraries, include = F}

knitr::opts_chunk$set(echo = FALSE, 
                      message=FALSE, 
                      warning=FALSE, 
                      dev="cairo_pdf", 
                      fig.width=7, fig.height=3.5)

```

``` {r libs, eval = T, echo = F, warning = F, message = F, include = F}


rm(list = ls())


# Add this to your R code:
#.libPaths(c("/projappl/project_2003256/project_rpackages", #.libPaths()))
#libpath <- .libPaths()[1]

.libPaths(c("/projappl/project_2003256/project_rpackages", .libPaths()))


# , eval = FALSE
library(data.table)
library(dplyr)
library(raster)
library(ggplot2)
library(sf)
library(stringr)
library(gridExtra)
library(tidyr)
library(ggpubr)
#library(RColorBrewer)

```


```{r set-my-theme, eval = T, echo = F, warning = F, message = F, include = F}

theme_set(theme_classic())
#theme_set(theme_grey())
theme_update(panel.grid.major = element_line(colour = "grey95",
                                             size = 0.1,
                                             linetype = 2),
             strip.background = element_rect(color="grey95", 
                                             fill="grey95",
                                             size=0.1, 
                                             linetype="solid"))

```

```{r read-input-data, eval = T, echo = F, warning = F, message = F, include = F}

# Read datasets:
# ----------------------------------------
#df <- fread("C:/MyTemp/myGitLab/windDamage/output/even_flow/final_df_solution8.csv")

df <- fread("/projappl/project_2003256/windDamage/output/final_df_solution8.csv")


# stands geometry
#df.geom <- st_read(paste0(getwd(),"/14.534/14.534/mvj_14.534.shp"))

#df.geom <- st_read("C:/MyTemp/avohaakut_db/14.534/14.534/mvj_14.534.#shp")

#df.geom <- subset(df.geom, select = c("KUVIO_ID"))
#names(df.geom) <- c("id", "geometry")
#df.geom$area <- st_area(df.geom)
#df.geom <- subset(df.geom, id %in% unique(df$id))



# replace all NA in volume by 0 - because not volume is available there
df<- 
  df %>% 
  dplyr::mutate(V_stand_log = replace_na(V_stand_log, 0)) %>% 
  dplyr::mutate(V_stand_pulp = replace_na(V_stand_pulp, 0)) %>% 
  dplyr::mutate(V_strat_max = replace_na(V_strat_max, 0)) %>% 
  dplyr::mutate(V_strat_max_log = replace_na(V_strat_max_log, 0)) %>% 
  dplyr::mutate(V_strat_max_pulp = replace_na(V_strat_max_pulp, 0)) %>% 
  dplyr::mutate(Harvested_V_log_under_bark = replace_na(Harvested_V_log_under_bark, 0)) %>% 
  dplyr::mutate(Harvested_V_pulp_under_bark = replace_na(Harvested_V_pulp_under_bark, 0)) 


# Replace the no_SA values in TwoRegms: change to Management
df <- 
  df %>% 
  dplyr::mutate(Management = twoRegm) %>% # copy the columns 
  dplyr::mutate(Management = replace(Management, # replace the values
                                     Management == "no_SA", "Active")) %>%
    dplyr::mutate(Management = replace(Management, # replace the values
                                     Management == "SA", "Set Aside"))
  
  
```

```{r plot-details, echo = F, eval = T}

# DEfine own palette
# color blind
cbp1 <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

plot_line_details <- function() {
  list( 
    geom_line(aes(linetype = scenSimpl2, 
                  color = scenSimpl2),
            lwd = 0.8),
    scale_color_manual(values = cbp1),
    labs(color = "Scenario",
        linetype = "Scenario"), # geom_line(size = 1) + 
   # facet_wrap(.~ twoRegm), # + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "bottom")
  )
}


plot_lineCumul_details <- function() {
 list( 
  geom_area(position="stack", 
             stat="identity",
             alpha = 0.2,
             color = "white"), 
  geom_line(position = "stack", 
            size = 1.2),
  scale_linetype_manual(values = c("solid", "dotdash")),
  scale_color_manual(values = cbp1),
  scale_fill_manual(values = cbp1),
  facet_wrap(.~scenSimpl2),
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "bottom")
  )
}






```

## Dynamic parameters contributing to wind risk

### Species composition

The intensification of the harvesting changes the stand species composition over time (Fig. \ref{species_change}). Intensification of the harvesting favorize the proportion of the Norway spruce and others (deciduous) tree species instead of Scots pine, which likely in turn increases wind risk over the stands. Proportion of the pine lowers with higher harvest intensities.     

```{r species_change, eval = T, echo = F, warning = F, message = F, fig.width = 7, fig.height = 3.5, fig.cap = "Changes in species composition under different management groups and harvest intensity."}

# get mean count for each species over SA gradient - plot over SA gradient

p.species.npi <- 
  df %>%
  group_by(NPI, scenSimpl2, species, twoRegm) %>% 
  tally()  %>% 
  ggplot(aes(x = NPI,
             y = n/(1470*21)*100,
             group = scenSimpl2,
             color = scenSimpl2)) +
  geom_line(aes(linetype = scenSimpl2, 
                  color = scenSimpl2),
            lwd = 0.8) +
   scale_color_manual(values = cbp1)+
 # scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("NPI k € by ha") +
  ylab("stands\n(%)") +
  facet_grid(species~ twoRegm) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5), 
        legend.position = "bottom")
  


p.species.year <- 
  df %>%
  group_by(year, scenSimpl2, species, twoRegm) %>% 
  tally()  %>% 
  ggplot(aes(x = year,
             y = n/(1470*20)*100,
             group = scenSimpl2,
             color = scenSimpl2)) +
  geom_line(aes(linetype = scenSimpl2, 
                  color = scenSimpl2),
            lwd = 0.8) +
   scale_color_manual(values = cbp1) +
 # scale_color_brewer(palette="Greens") +
  labs(color = "Scenario",
       linetype = "Scenario") + # geom_line(size = 1) + 
  xlab("NPI k € by ha") +
  ylab("stands\n(%)") +
  facet_grid(species~ twoRegm) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5), 
        legend.position = "bottom")

# ggarrange(p.species.npi, p.species.year)

```

### Dominant tree heights 

The intensification of the harvest reduce mean tree height for other species to half (from 20 m  to 10 m) in RF, while CCF slightly increases mean tree heights.For pine and spruce trees, harvest intensification maintain the mean tree height of the stand to 20 m(other) to 22 m (spruce). Spruce is higher then pine and other stree species.   

```{r res_D_tree_height, eval = T, echo = F, warning = F, message = F, fig.width = 7, fig.height = 3.5, fig.cap = "Mean dominant tree height under different management groups and harvest intensity."}

# get mean count for each species over SA gradient - plot over SA gradient

p.H.npi <- df %>%
  group_by(NPI, scenSimpl2, twoRegm) %>% 
  summarise(H_mean = mean(H_dom, na.rm = T)) %>% 
  ggplot(aes(x = NPI,
             y = H_mean/10,
             group = scenSimpl2,
             color = scenSimpl2)) +
  xlab("NPI k € by ha") +
  ylab("tree height\n(m)") +
  ylim(0, 25) +
       plot_line_details()
  
p.H.year <- df %>%
  group_by(year, scenSimpl2, twoRegm) %>% 
  summarise(H_mean = mean(H_dom, na.rm = T)) %>% 
  ggplot(aes(x = year,
             y = H_mean/10,
             group = scenSimpl2,
             color = scenSimpl2)) +
  xlab("NPI k € by ha") +
  ylab("tree height\n(m)") +
  ylim(0, 25) +
  plot_line_details()

```


### Tree count

```{r mean_tree_n, eval = T}

p.tree.n.npi <- 
  df %>%
  group_by(NPI, scenSimpl2, twoRegm) %>% 
  summarise(tree_n = mean(N, na.rm = T)) %>% 
  ggplot(aes(x = NPI,
             y = tree_n/100,
             group = scenSimpl2,
             color = scenSimpl2)) +
  xlab("NPI k € by ha") +
  ylab("Mean # tree\n(*100)") +
  ylim(0, 50) +
  plot_line_details()
 
p.tree.n.year <- 
  df %>%
  group_by(year, scenSimpl2, twoRegm) %>% 
  summarise(tree_n = mean(N, na.rm = T)) %>% 
  ggplot(aes(x = year,
             y = tree_n/100,
             group = scenSimpl2,
             color = scenSimpl2)) +
  xlab("NPI k € by ha") +
  ylab("Mean # tree\n(*100)") +
  ylim(0, 50) +
  plot_line_details()

#range(df$N)
#hist(df$N)

```




### Frequency of open stands

The proportion of the open edge stands remains very high over whole simulation run, which is likely due to the fragmeneted landscape (85-95% of stands by species, Fig. 2, Fig. XX). However, increasing harvest intensity lowers number of stands with open edge when dominated by other species, whereas increases those numbers for pine and spruce dominated spatnd, especially under RF. The CCF and ALL management groups maintain the number of the open edge stands similar to completely set aside stands.   
   

```{r fig_6_count_open_edge, eval = T, echo = F, warning = F, message = F, fig.width = 7, fig.height = 3.5, fig.cap = "Yearly proportion stands with open edge by species, management group and over the harvest intensity gradient. Note y axis starts at 80."}

# calculate this as a proportion of teh open edge stands from teh number of available stands for particular species????

# Calculate how many stands have open edge

p.open.edge.npi <- 
  df %>% 
  group_by(scenSimpl2, NPI, open_edge, twoRegm) %>% 
  filter(open_edge == TRUE) %>% 
  tally() %>% 
#  print(n = 250)
  ggplot(aes(x = NPI, #factor(scenNumb),
             y = n/20/1470*100,  # number of stands by one year
             color = scenSimpl2,
             group = scenSimpl2)) + 
  ylim(0, 100) +
  xlab("NPI k € by ha") + 
  ylab("open edge stands\n(%)") +
  plot_line_details()



p.open.edge.year <- 
  df %>% 
  group_by(scenSimpl2, year, open_edge, twoRegm) %>% 
  filter(open_edge == TRUE) %>% 
  tally() %>% 
  ggplot(aes(x = year, #factor(scenNumb),
             y = n/21/1470*100,  # number of stands by one year
             color = scenSimpl2,
             group = scenSimpl2)) + # ,
 
  ylim(0, 100) +
  xlab("NPI k € by ha") + 
  ylab("open edge stands\n(%)") +
  plot_line_details()

```



### Thinning frequency

the highest frequency of thinnings is under CCF management regimes, which lineraly increase with harvesting intensity for all tree species. Numbers of thinnings in RF remains relatively low comparing to CCF and ALL, and strongly increases at high harvest intensity (from 3K for pine and from 5K for spruce). The frequency of thinnings in CCF increases 3-4 times in CCF comparing to RF. 



```{r fig_thin_frequency, eval = T, echo = F, warning = F, message = F, fig.width = 7, fig.height = 4, fig.cap = "The frequency of the thinnings by management groups, species and harvest intensity gradient"}

# Identify the number of the non NA record of teh thinning actuons
# if thinning occurs, it is represented by the non-na string
# works on dummy datasets, try on specidic id
# calculate frequency of thinnings by scenarios, devide by 20 to have mean over 20 years

df$THIN2 <- df$THIN

df$THIN2[df$THIN2==""]<- NA



# Calculate the number of non NA values by groups
p.thin.npi <-
  df %>% 
  group_by(scenSimpl2, NPI, twoRegm) %>% 
  summarise(non_na_count = sum(!is.na(THIN2))) %>% 
  ggplot(aes(x = NPI, 
             y = non_na_count/20/1470*100,  # number of stands by one year
             color = scenSimpl2,
             group = scenSimpl2)) + # ,
  plot_line_details() +
  ylim(0, 20) +
  xlab("NPI k € by ha") + 
  ylab("Mean # of thinned stands\n(year/landscape)") 

p.thin.year <-
  df %>% 
  group_by(scenSimpl2, year, twoRegm) %>% 
  summarise(non_na_count = sum(!is.na(THIN2))) %>% 
  ggplot(aes(x = year, 
             y = non_na_count/21/1470*100,  # number of stands by one year
             color = scenSimpl2,
             group = scenSimpl2)) + # ,
  plot_line_details() +
  ylim(0, 20) +
  xlab("NPI k € by ha") + 
  ylab("Mean # of thinned stands\n(year/landscape)") 
  


```
```{r mean_stand_age, eval = T, echo = F}

p.age.npi <- 
  df %>%
  group_by(NPI, scenSimpl2, twoRegm) %>% 
  summarise(age_mean = mean(Age, na.rm = T)) %>% 
  ggplot(aes(x = NPI,
             y = age_mean,
             group = scenSimpl2,
             color = scenSimpl2)) +
  xlab("NPI k € by ha") +
  ylab("Mean stand age\n") +
  ylim(0, 150) +
  plot_line_details() 


p.age.year <- 
  df %>%
  group_by(year, scenSimpl2, twoRegm) %>% 
  summarise(age_mean = mean(Age, na.rm = T)) %>% 
  #  mutate(age_mean = mean(Age)) %>% 
  ggplot(aes(x = year,
             y = age_mean,
             group = scenSimpl2,
             color = scenSimpl2)) +
  xlab("Years") +
  ylab("Mean age\n") +
  ylim(0, 150) +
  plot_line_details() 


```

```{r plot-dynamic-vars, fig.width = 7, fig.height = 12, fig.cap="dynamics variables over harvest gradient and years"}
#library(egg)
ggarrange( p.species.npi, p.species.year, # species, 
           p.H.npi, p.H.year,             # tree_heigh, 
           p.tree.n.npi, p.tree.n.year,   # tree count, 
           p.open.edge.npi, p.open.edge.year, #open stand,
           p.thin.npi, p.thin.year,       # thinning, 
           p.age.npi, p.age.year,         # age 
           ncol = 2, nrow = 6,
           heights = c(2.5,2,2,2,2,2),
           align = "h",
           common.legend = TRUE, legend="bottom")
 



```


```{r show-plot-volume, fig.width=7, fig.height=6, fig.cap="Mean log (left) and pulp (right) timber volume of the top tree layer in the stands over management groups over harvesting intensity gradient (top) and over years (bottom)"}
 
# Plot both plots: stand volume and highest stratum volume
# ---------------------
# 
ggarrange(p.mean.risk.npi,  p.mean.risk.time,
           V.strat.log.npi,   V.strat.log.year,
           V.strat.pulp.npi, V.strat.pulp.year, #V.strat, 
           ncol = 2, nrow = 3,
           common.legend = TRUE, legend="bottom")

```
